---
kind: pipeline
type: docker
name: default

volumes:
- name: cache
  host:
    path: /cache/magic-wall

steps:
- name: restore-cache
  image: drillster/drone-volume-cache
  settings:
    restore: true
    mount:
      - ./.pip
      - ./.pip-cache
      - ./node_modules
  volumes:
  - name: cache
    path: /cache

- name: docker-build-django
  image: plugins/docker
  environment:
    PIP_CACHE_DIR: ".pip-cache"
    PYTHONUSERBASE: ".pip"
  settings:
    registry: r.sacovo.ch
    repo: r.sacovo.ch/sacovo/magic-wall-backend
    tags: ${DRONE_COMMIT_SHA}
    auto_tag: true
    username:
      from_secret: portus_username
    password:
      from_secret: portus_token
    cache_from: r.sacovo.ch/sacovo/magic-wall-backend
  depends_on:
  - restore-cache

- name: build-angular
  image: node
  commands:
  - cd app/
  - npm install
  - npm run build app -- --prod
  depends_on:
  - restore-cache

- name: rebuild-cache
  image: drillster/drone-volume-cache
  settings:
    rebuild: true
    mount:
      - ./node_modules
  volumes:
  - name: cache
    path: /cache
  depends_on:
  - build-angular
  - docker-build-django

- name: docker-build-app
  image: plugins/docker
  settings:
    registry: r.sacovo.ch
    repo: r.sacovo.ch/sacovo/magic-wall-frontend
    tags: ${DRONE_COMMIT_SHA}
    auto_tag: true
    username:
      from_secret: portus_username
    password:
      from_secret: portus_token
    context: app/
    dockerfile: app/Dockerfile

  depends_on:
  - build-angular

---
kind: signature
hmac: 2ded63ecfd11fd3a3cd2104567491ea1712e5722c8fa3b3fe222a47e72237a84

...
